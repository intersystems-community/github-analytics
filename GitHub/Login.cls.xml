<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<Class name="GitHub.Login">
<Abstract>1</Abstract>
<Super>%RegisteredObject</Super>
<TimeCreated>63910,83565.045361</TimeCreated>

<Method name="CreateLoggedSession">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[login="",password="",&session]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	s request = ##class(%Net.HttpRequest).%New()
	
	s sslConfigName = ##class(GitHub.OrganizationPage).#SERVER
	s request.Server = sslConfigName
	s sc = ##class(SSL.Configuration).SSLConfig( sslConfigName ) if 'sc {
		w !, "SSLConfig error: ", sc 	
	}
	s request.SSLConfiguration = sslConfigName
	s request.Https=1
	
	s sc = request.Get("/login")
	s strm = ##class(%Stream.FileCharacter).%New()
	s sc = strm.CopyFrom( request.HttpResponse.Data )
	
	s authenticityToken = ..ParseAuthenticityToken(strm)
	
	d request.InsertFormData("commit","Sign in")
	, request.InsertFormData("login",login), request.InsertFormData("password",password)
	, request.InsertFormData("authenticity_token",authenticityToken) , request.InsertFormData("utf8","&#x2713;")
	s sc = request.Post("/session") 
	
	s setCookie = request.HttpResponse.Headers("SET-COOKIE")
	s setCookie = $p(setCookie,",",1,2)
	
	s session("name") = $p(setCookie,"="), session("secure") = 1
	, session("value") = $p(setCookie,";"), session("value") = $p(session("value"),"=",2)
	, session("path") = $p(setCookie,";",2), session("path") = $p(session("path"),"path=",2)
	, session("expires") = $p(setCookie,";",3), session("expires") = $p(session("expires"),"expires=",2)

	Q sc
]]></Implementation>
</Method>

<Method name="ParseAuthenticityToken">
<Description><![CDATA[
Extract authenticity token
Code below is one line
<!-- </textarea> --><!-- '"` --><form accept-charset="UTF-8" action="/session" 
data-form-nonce="6c0fdd0779b0e7e75813fed57e639c50034bcc0f" method="post"><div style="margin:0;padding:0;display:inline">
<input name="utf8" type="hidden" value="&#x2713;" /><input name="authenticity_token" type="hidden" 
value="CLpoy4KS/Nbnn4uyTd/vf/WuhcF8NOhU4QSualOfABlYzSIp2f6nEBDozj5y05hYuiGJRS6fr1/TN9SEbouO4Q==" /></div>      ]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>html</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	s begin = html.FindAt( 1, "name=""authenticity_token""" ) 
	s end = html.FindAt( begin , "</div>"  )
	s sc = html.MoveTo( begin ) 
	s length = end - begin
	s authTokenHtml = html.Read( .length )
	
	s authToken = $p( authTokenHtml, "value=""", 2 )	
	s authToken = $p( authToken, """")
	Q authToken
]]></Implementation>
</Method>
</Class>
</Export>
