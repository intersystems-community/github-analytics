<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<Class name="GitHub.Login">
<Abstract>1</Abstract>
<Super>%RegisteredObject</Super>
<TimeCreated>63910,83565.045361</TimeCreated>

<Method name="CreateLoggedSession">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[login="",password="",&session]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set request = ##class(%Net.HttpRequest).%New()
	
	set sslConfigName = ##class(GitHub.OrganizationPage).#SERVER
	set request.Server = sslConfigName
	set sc = ##class(SSL.Configuration).SSLConfig( sslConfigName ) if 'sc {
		write !, "SSLConfig error: ", sc 	
	}
	set request.SSLConfiguration = sslConfigName
	set request.Https=1
	
	set sc = request.Get("/login")
	set strm = ##class(%Stream.FileCharacter).%New()
	set sc = strm.CopyFrom( request.HttpResponse.Data )
	
	set authenticityToken = ..ParseAuthenticityToken(strm)
	
	do request.InsertFormData("commit","Sign in")
	, request.InsertFormData("login",login), request.InsertFormData("password",password)
	, request.InsertFormData("authenticity_token",authenticityToken) , request.InsertFormData("utf8","&#x2713;")
	set sc = request.Post("/session") 
	
	set setCookie = request.HttpResponse.Headers("SET-COOKIE")
	set setCookie = $piece(setCookie,",",1,2)
	
	set session("name") = $piece(setCookie,"="), session("secure") = 1
	, session("value") = $piece(setCookie,";"), session("value") = $piece(session("value"),"=",2)
	, session("path") = $piece(setCookie,";",2), session("path") = $piece(session("path"),"path=",2)
	, session("expires") = $piece(setCookie,";",3), session("expires") = $piece(session("expires"),"expires=",2)

	Quit sc
]]></Implementation>
</Method>

<Method name="ParseAuthenticityToken">
<Description><![CDATA[
Extract authenticity token
Code below is one line
<!-- </textarea> --><!-- '"` --><form accept-charset="UTF-8" action="/session" 
data-form-nonce="6c0fdd0779b0e7e75813fed57e639c50034bcc0f" method="post"><div style="margin:0;padding:0;display:inline">
<input name="utf8" type="hidden" value="&#x2713;" /><input name="authenticity_token" type="hidden" 
value="CLpoy4KS/Nbnn4uyTd/vf/WuhcF8NOhU4QSualOfABlYzSIp2f6nEBDozj5y05hYuiGJRS6fr1/TN9SEbouO4Q==" /></div>      ]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>html</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set begin = html.FindAt( 1, "name=""authenticity_token""" ) 
	set end = html.FindAt( begin , "</div>"  )
	set sc = html.MoveTo( begin ) 
	set length = end - begin
	set authTokenHtml = html.Read( .length )
	
	set authToken = $piece( authTokenHtml, "value=""", 2 )	
	set authToken = $piece( authToken, """")
	Quit authToken
]]></Implementation>
</Method>
</Class>
</Export>
